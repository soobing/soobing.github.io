{
    "componentChunkName": "component---src-templates-blog-template-js",
    "path": "/react/server-rendering-and-react-query/",
    "result": {"data":{"cur":{"id":"d77b67b4-3ea0-53b0-b513-8a24dd4da08d","html":"<p>Next.js나 Remix 같은 프레임워크 내에서 React-Query를 사용한다면, 서버 렌더링 될 때 요청 후 응답받은 데이터를 SPA 방식으로 전환되고 나서도 유지할 수 있을까요? 어떻게 가능할까요? React Query의 <code>hydrate</code>와 <code>dehydrate</code>는 서버에서 미리 가져온 데이터를 클라이언트 사이드에서 재사용 할 수 있게 해줍니다. 이번 글을 통해 서버 렌더링과 어떻게 이를 가능하게 하는지 <code>hydrate</code>와 <code>dehydrate</code>에  대해서 알아봅시다.</p>\n<h2 id=\"server-rendering\" style=\"position:relative;\"><a href=\"#server-rendering\" aria-label=\"server rendering permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Server Rendering</h2>\n<p>서버 렌더링은 사용자가 페이지를 로드하는 즉시 볼 수 있는 초기 HTML을 서버에서 생성하는 행위입니다. 이는 페이지 요청 시 즉시 발생할 수 있으며(SSR), 이전 요청이 캐시 되었거나 빌드 시간에 미리 생성(SSG) 할 수도 있습니다.</p>\n<p>클라이언트 렌더링 애플리케이션에서는 사용자에게 화면에 콘텐츠를 표시하기 전에 최소 3번의 서버 왕복(roundtrips)이 필요합니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"bash\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1. |-&gt; Markup (내용 없이 - 비어있는 index.html)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">2.   |-&gt; JS</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">3.     |-&gt; Query</span></span></span></code></pre>\n<p>서버 렌더링은 위의 과정을 아래와 같이 같이 변환한다는 것입니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"bash\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">1. |-&gt; Markup (내용이 채워져있고, data가 초기화 되어있음)</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">2.   |-&gt; JS</span></span></span></code></pre>\n<p>1번이 완료되면 사용자는 콘텐츠를 볼 수 있고, 2번이 끝나면 페이지가 상호작용 가능하고 클릭할 수 있게 됩니다. 마크업에 필요한 초기 데이터가 포함되어 있기 때문에, 적어도 데이터를 다시 검증할 필요가 있을 때까지는 클라이언트에서 3번을 실행할 필요가 없습니다.</p>\n<p>서버 렌더링을 통해 1번 과정에서 내용이 채워져 있고 data가 초기화되어있는 html을 생성하기 위해서는 마크업을 생성/렌더링 하기 전에 해당 데이터를 미리 가져와야(prefetch) 하며, 데이터를 직렬화 가능한(serializable) 형식으로 dehydrate 시켜 마크업에 포함(embed) 시키고, 클라이언트에서는 React Query 캐시로 해당 데이터를 hydrate 하여 새로운 fetch를 클라이언트에서 추가적으로 할 필요가 없도록 해야 합니다.</p>\n<h2 id=\"initialdata-를-사용하여-서버에서-fetch한-데이터-사용하기\" style=\"position:relative;\"><a href=\"#initialdata-%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EC%97%AC-%EC%84%9C%EB%B2%84%EC%97%90%EC%84%9C-fetch%ED%95%9C-%EB%8D%B0%EC%9D%B4%ED%84%B0-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"initialdata 를 사용하여 서버에서 fetch한 데이터 사용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><code>initialData</code> 를 사용하여 서버에서 fetch한 데이터 사용하기</h2>\n<p>React Query의 <code>prefetching</code>과 <code>dehydrate</code>/<code>hydrate</code> API를 전혀 사용하지 않고, useQuery에 raw 데이터를 <code>initialData</code> 옵션으로 전달하는 방법입니다. 이 방법을 이용해서도 서버에서 미리 가져온 데이터를 클라이언트 사이드에서 재사용할 수 있는데요, 어떤 문제점이 있고 왜 Hydration API가 나오게 되었는지 살펴봅시다. Next.js에서 React-Query를 사용한다고 가정해 봅니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// Next.js 페이지 라우터 예시</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getServerSideProps</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">posts</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getPosts</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">props:</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">posts</span><span class=\"mtk1\"> } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Posts</span><span class=\"mtk1\">(</span><span class=\"mtk12\">props</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">useQuery</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> [</span><span class=\"mtk8\">&#39;posts&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryFn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">getPosts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">initialData:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">props</span><span class=\"mtk1\">.</span><span class=\"mtk12\">posts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><code>getStaticProps</code>나 이전의 <code>getInitialProps</code>에서도 잘 작동합니다. 이 방법은 설정은 최소한으로 하고, 일부 경우에는 빠른 해결책이 될 수 있지만, 전체 접근법에 비해 고려해야 할 몇 가지 tradeoff가 있습니다.</p>\n<p>참고: 여기서는 React Query를 사용하되, 데이터를 사전에 가져오기 위해 <code>initialData</code> 옵션을 사용하는 경우를 이야기하고 있음.*</p>\n<ul>\n<li>트리 매우 아래쪽에 있는 컴포넌트에서 <code>useQuery</code>를 호출하는 경우, <code>initialData</code>를 그 지점까지 전달해야 합니다.</li>\n<li>여러 위치에서 동일한 쿼리로 <code>useQuery</code>를 호출하는 경우, <code>initialData</code>를 하나에만 전달하는 것은 앱이 변경될 때 취약하고 문제가 발생할 수 있습니다. <code>initialData</code>와 함께 <code>useQuery</code>를 가진 컴포넌트를 제거하거나 이동하면, 컴포넌트가 다른 컴포넌트 내부에 깊숙이 위치하고 있고, 이런 구조에서 <code>useQuery</code>를 사용한다면, <em>(상위 컴포넌트에서 제공되는 <code>initialData</code>가 중첩된 하위 컴포넌트의 <code>useQuery</code>에 올바르게 전달되지 않아서)</em> 더 이상 데이터를 가지고 있지 않을 수 있습니다. 필요한 모든 쿼리에 <code>initialData</code>를 전달하는 것도 번거로울 수 있습니다.</li>\n<li>서버에서 쿼리가 언제 fetch 되었는지 알 수 없으므로, <code>dataUpdatedAt</code>와 쿼리의 refetching 여부는 페이지가 로드된 시점에 따라 결정됩니다.</li>\n<li>쿼리에 대한 데이터가 캐시에 이미 존재하는 경우에도, <code>initialData</code>는 이 데이터를 결코 덮어쓰지 않습니다. 심지어 새 데이터가 기존 데이터보다 신선하더라도 말입니다.\n<ul>\n<li>왜 특히 더 나쁜지를 이해하려면, 위의 <code>getServerSideProps</code> 예를 고려해 보세요. 페이지를 여러 번 왔다 갔다 하면, 매번 <code>getServerSideProps</code>가 호출되어 새로운 데이터를 가져오지만, <code>initialData</code> 옵션을 사용하기 때문에 클라이언트 캐시와 데이터는 결코 업데이트되지 않습니다.</li>\n</ul>\n</li>\n</ul>\n<p>이러한 단점은 Hydration API를 사용하여 해결할 수 있고, 설정 또한 더욱 간단합니다.</p>\n<h2 id=\"hydration-api-사용하기\" style=\"position:relative;\"><a href=\"#hydration-api-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0\" aria-label=\"hydration api 사용하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://tanstack.com/query/v5/docs/react/guides/ssr#using-the-hydration-apis\">Hydration API</a> 사용하기</h2>\n<p>React Query에서는 <code>dehydrate</code>와 <code>hydrate</code> 함수를 제공하여 이 과정을 간소화합니다. 각 API의 역할과 사용방법 그리고 공식 문서 예시에 대해서 알아보도록 합시다.</p>\n<h3 id=\"hydrate와-dehydrate의-역할\" style=\"position:relative;\"><a href=\"#hydrate%EC%99%80-dehydrate%EC%9D%98-%EC%97%AD%ED%95%A0\" aria-label=\"hydrate와 dehydrate의 역할 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Hydrate와 Dehydrate의 역할</h3>\n<ul>\n<li><code>dehydrate</code>는 서버에서 React Query의 상태를 클라이언트로 전송할 수 있는 형태로 만들기 위해 사용됩니다. 서버에서 데이터를 가져온 후, 이 데이터를 직렬화(serialization) 하여 클라이언트로 전송합니다. 직렬화된 데이터는 <code>DehydratedState</code> 형태로 표현되며, 클라이언트 측에서 <code>hydrate</code> 함수를 통해 다시 React Query 상태로 변환됩니다.</li>\n<li><code>hydrate</code>는 클라이언트 측에서 직렬화된 상태를 받아 이를 React Query의 상태로 변환합니다. 이 과정은 서버에서 미리 가져온 데이터를 클라이언트의 쿼리 캐시에 적용하여, 네트워크 요청 없이 데이터를 사용할 수 있게 합니다.</li>\n</ul>\n<h3 id=\"사용방법\" style=\"position:relative;\"><a href=\"#%EC%82%AC%EC%9A%A9%EB%B0%A9%EB%B2%95\" aria-label=\"사용방법 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>사용방법</h3>\n<ol>\n<li>프레임워크 로더 함수에서 <code>const queryClient = new QueryClient(options)</code>를 생성합니다.</li>\n<li>앱 로더 함수에서, 미리 가져오고 싶은 각 쿼리에 대해 <code>await queryClient.prefetchQuery(...)</code>를 실행합니다.\n<ul>\n<li>가능하면 <code>await Promise.all(...)</code>을 사용해 쿼리들을 병렬로 가져옵니다.</li>\n<li>미리 가져오지 않은 쿼리들이 있어도 괜찮습니다. 이 쿼리들은 서버에서 렌더링 되지 않고, 애플리케이션이 상호작용할 수 있게 된 후 클라이언트에서 가져옵니다. 이는 사용자 상호작용 후에만 표시되거나 또는 페이지 하단에 있어 더 중요한 콘텐츠의 로딩을 방해하지 않기 위해 사용됩니다.</li>\n</ul>\n</li>\n<li>로더에서 <code>dehydrate(queryClient)</code>를 반환합니다. 이 반환 구문의 정확한 문법은 프레임워크에 따라 다를 수 있습니다.</li>\n<li><code>&#x3C;HydrationBoundary state={dehydratedState}></code>로 트리를 감싸는데, <code>dehydratedState</code>는 프레임워크 로더에서 옵니다. <code>dehydratedState</code>를 얻는 방법도 프레임워크에 따라 다릅니다.\n<ul>\n<li>이 작업은 각 라우트마다 수행하거나, 애플리케이션 최상단에서 수행하여 보일러플레이트를 줄일 수 있습니다.</li>\n</ul>\n</li>\n</ol>\n<h3 id=\"nextjs에서-예시\" style=\"position:relative;\"><a href=\"#nextjs%EC%97%90%EC%84%9C-%EC%98%88%EC%8B%9C\" aria-label=\"nextjs에서 예시 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a><a href=\"https://tanstack.com/query/v5/docs/react/guides/ssr#full-nextjs-pages-router-example\">Next.js에서 예시</a></h3>\n<ul>\n<li>\n<p>초기 세팅(앱 로더 함수)</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// _app.tsx</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">QueryClient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">QueryClientProvider</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@tanstack/react-query&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MyApp</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">Component</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pageProps</span><span class=\"mtk1\"> }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">React</span><span class=\"mtk1\">.</span><span class=\"mtk11\">useState</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    () </span><span class=\"mtk4\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">QueryClient</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">defaultOptions:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">queries:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// SSR에서는 클라이언트에서 즉시 재요청하는 것을 피하기 위해,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// default staleTime을 0보다 높게 설정하는 것이 일반적입니다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">staleTime:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">60</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">QueryClientProvider</span><span class=\"mtk1\"> </span><span class=\"mtk12\">client</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk12\">queryClient</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">Component</span><span class=\"mtk1\"> </span><span class=\"mtk4\">{</span><span class=\"mtk1\">...</span><span class=\"mtk12\">pageProps</span><span class=\"mtk4\">}</span><span class=\"mtk1\"> </span><span class=\"mtk17\">/&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk10\">QueryClientProvider</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n<li>\n<p>각 라우터에서</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// pages/posts.jsx</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">dehydrate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">HydrationBoundary</span><span class=\"mtk1\">, </span><span class=\"mtk12\">QueryClient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">useQuery</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@tanstack/react-query&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 이것은 getServerSideProps에서도 동일할 수 있습니다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getStaticProps</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">QueryClient</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prefetchQuery</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> [</span><span class=\"mtk8\">&#39;posts&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryFn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">getPosts</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">props:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">dehydratedState:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">dehydrate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Posts</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// useQuery는 &lt;PostsRoute&gt;의 더 깊은 자식에서도 마찬가지로 사용될 수 있으며,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// 어느 방식이든 데이터는 즉시 사용 가능합니다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">data</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">useQuery</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> [</span><span class=\"mtk8\">&#39;posts&#39;</span><span class=\"mtk1\">], </span><span class=\"mtk12\">queryFn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">getPosts</span><span class=\"mtk1\"> })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// 이 쿼리는 서버에서 미리 가져오지 않았으며, 클라이언트에서 시작될 때까지 요청하지 않을 것입니다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// 이 두 가지 패턴을 혼합해서 사용하는 것은 문제가 없습니다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">data</span><span class=\"mtk1\">: </span><span class=\"mtk12\">commentsData</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">useQuery</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> [</span><span class=\"mtk8\">&#39;posts-comments&#39;</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryFn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">getComments</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PostsRoute</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">dehydratedState</span><span class=\"mtk1\"> }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk12\">HydrationBoundary</span><span class=\"mtk1\"> </span><span class=\"mtk12\">state</span><span class=\"mtk1\">={</span><span class=\"mtk12\">dehydratedState</span><span class=\"mtk1\">}&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk12\">Posts</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk12\">HydrationBoundary</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n<li>\n<p>팁1) 보일러 플레이트를 없애기 위한 예시</p>\n<ul>\n<li>\n<p>모든 라우트에 이 부분을 포함하는 것은 상당한 보일러 플레이트처럼 보일 수 있습니다. 이 방법에 문제가 있는 것은 아니지만, 이 보일러 플레이트를 제거하고 싶다면, Next.js에서 설정을 다음과 같이 수정할 수 있습니다.</p>\n</li>\n<li>\n<p>AS-IS (보일러 플레이트 없애기 전)</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk11\">PostsRoute</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">dehydratedState</span><span class=\"mtk1\"> }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;</span><span class=\"mtk12\">HydrationBoundary</span><span class=\"mtk1\"> </span><span class=\"mtk12\">state</span><span class=\"mtk1\">={</span><span class=\"mtk12\">dehydratedState</span><span class=\"mtk1\">}&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      &lt;</span><span class=\"mtk12\">Posts</span><span class=\"mtk1\"> /&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    &lt;/</span><span class=\"mtk12\">HydrationBoundary</span><span class=\"mtk1\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n</li>\n<li>\n<p>TO-BE (보일러 플레이트 없앤 후)</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// _app.tsx</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">HydrationBoundary</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">QueryClient</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">QueryClientProvider</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@tanstack/react-query&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">MyApp</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">Component</span><span class=\"mtk1\">, </span><span class=\"mtk12\">pageProps</span><span class=\"mtk1\"> }) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">React</span><span class=\"mtk1\">.</span><span class=\"mtk11\">useState</span><span class=\"mtk1\">(() </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">QueryClient</span><span class=\"mtk1\">())</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">QueryClientProvider</span><span class=\"mtk1\"> </span><span class=\"mtk12\">client</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk12\">queryClient</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">HydrationBoundary</span><span class=\"mtk1\"> </span><span class=\"mtk12\">state</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk12\">pageProps</span><span class=\"mtk1\">.</span><span class=\"mtk12\">dehydratedState</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">Component</span><span class=\"mtk1\"> </span><span class=\"mtk4\">{</span><span class=\"mtk1\">...</span><span class=\"mtk12\">pageProps</span><span class=\"mtk4\">}</span><span class=\"mtk1\"> </span><span class=\"mtk17\">/&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk10\">HydrationBoundary</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk10\">QueryClientProvider</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// pages/posts.tsx</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// HydrationBoundary를 포함한 PostsRoute를 제거하고 대신 Posts를 직접 내보냅니다:</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Posts</span><span class=\"mtk1\">() { ... }</span></span></span></code></pre>\n</li>\n<li>\n<p>팁2) 서버에서 조건부 prefetch 하는 방법</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getServerSideProps</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">QueryClient</span><span class=\"mtk1\">()</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">fetchQuery</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> [</span><span class=\"mtk8\">&#39;user&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">email</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryFn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">getUserByEmail</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">if</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">user</span><span class=\"mtk1\">?.</span><span class=\"mtk12\">userId</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prefetchQuery</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> [</span><span class=\"mtk8\">&#39;projects&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">userId</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">queryFn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">getProjectsByUser</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    })</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">props:</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">dehydratedState:</span><span class=\"mtk1\"> </span><span class=\"mtk11\">dehydrate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">) } }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<ul>\n<li>\n<p>참고 - 클라이언트에서 조건부 fetch 하는법 (<code>enabled</code> 이용하기)</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 사용자 가져오기</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">data</span><span class=\"mtk1\">: </span><span class=\"mtk12\">user</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">useQuery</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> [</span><span class=\"mtk8\">&#39;user&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">email</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">queryFn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">getUserByEmail</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">userId</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">user</span><span class=\"mtk1\">?.</span><span class=\"mtk12\">id</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 그 다음 사용자의 프로젝트 가져오기</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">status</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">fetchStatus</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">data</span><span class=\"mtk1\">: </span><span class=\"mtk12\">projects</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} = </span><span class=\"mtk11\">useQuery</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> [</span><span class=\"mtk8\">&#39;projects&#39;</span><span class=\"mtk1\">, </span><span class=\"mtk12\">userId</span><span class=\"mtk1\">],</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">queryFn:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">getProjectsByUser</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// userId가 존재할 때까지 쿼리는 실행되지 않음</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">enabled:</span><span class=\"mtk1\"> !!</span><span class=\"mtk12\">userId</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">})</span></span></span></code></pre>\n</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"기타-참고사항\" style=\"position:relative;\"><a href=\"#%EA%B8%B0%ED%83%80-%EC%B0%B8%EA%B3%A0%EC%82%AC%ED%95%AD\" aria-label=\"기타 참고사항 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>기타 참고사항</h2>\n<ul>\n<li>서버와 클라이언트 간 시간 동기화: <code>staleTime</code> 설정은 서버에서 데이터를 가져온 시점을 기준으로 합니다. 서버의 시간 설정이 정확해야 올바르게 작동합니다.</li>\n<li>메모리 관리: 각 요청마다 새로운 <code>QueryClient</code>를 생성하는 경우, 서버의 메모리 사용량이 증가할 수 있습니다. 적절한 가비지 컬렉션 설정이 필요합니다.</li>\n<li>코드 분할과 요청 워터폴: 코드 분할을 사용하는 경우, 데이터 가져오기 코드를 메인 번들에 포함시킬지, 코드 분할된 번들에 넣을지 결정해야 합니다. 이는 성능과 요청 워터폴에 영향을 미칩니다.</li>\n</ul>\n<h2 id=\"결론\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EB%A1%A0\" aria-label=\"결론 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결론</h2>\n<p>React Query의 <code>hydrate</code>와 <code>dehydrate</code>는 서버 사이드 렌더링을 구현하는 데 있어 필수적인 도구입니다. 이들은 데이터를 효과적으로 전달하고, 애플리케이션의 성능을 최적화하는 데 중요한 역할을 합니다. 그러나 이 기능들을 사용할 때는 데이터의 필요성, 네트워크 오버헤드, 그리고 서버와 클라이언트 간의 일관성을 고려해야 합니다. 이를 통해 효율적이고 사용자 친화적인 SSR 경험을 구축할 수 있습니다.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .default-dark .mtk1 { color: #D4D4D4; }\n  .default-dark .mtk3 { color: #6A9955; }\n  .default-dark .mtk15 { color: #C586C0; }\n  .default-dark .mtk4 { color: #569CD6; }\n  .default-dark .mtk11 { color: #DCDCAA; }\n  .default-dark .mtk12 { color: #9CDCFE; }\n  .default-dark .mtk8 { color: #CE9178; }\n  .default-dark .mtk10 { color: #4EC9B0; }\n  .default-dark .mtk7 { color: #B5CEA8; }\n  .default-dark .mtk17 { color: #808080; }\n  .default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","excerpt":"Next.js나 Remix 같은 프레임워크 내에서 React-Query를 사용한다면, 서버 렌더링 될 때 요청 후 응답받은 데이터를 SPA 방식으로 전환되고 나서도 유지할 수 있을까요? 어떻게 가능할까요? React Query의 hydrate와 dehydrate는 서버에서 미리 가져온 데이터를 클라이언트 사이드에서 재사용 할 수 있게 해줍니다. 이번 글을 통해 서버 렌더링과 어떻게 이를 가능하게 하는지 hydrate와 dehydrate에  대해서 알아봅시다. Server Rendering 서버 렌더링은 사용자가 페이지를 로드하는 즉시 볼 수 있는 초기 HTML을 서버에서 생성하는 행위입니다. 이는 페이지 요청 시 즉시 발생할 수 있으며(SSR), 이전 요청이 캐시 되었거나 빌드 시간에 미리 생성(SSG) 할 수도 있습니다. 클라이언트 렌더링 애플리케이션에서는 사용자에게 화면에 콘텐츠를 표시하기 전에 최소 3번의 서버 왕복(roundtrips)이 필요합니다. 서버 렌더링은 위의 과정…","frontmatter":{"date":"December 10, 2023","title":"[React-Query] 서버에서 prefetching 한 데이터 사용하기","categories":"react","author":"soobing"},"fields":{"slug":"/react/server-rendering-and-react-query/"}},"next":{"id":"9c6b2391-e371-545b-b36b-85a35b38a7ac","html":"<blockquote>\n<p>원문: <a href=\"https://preactjs.com/blog/introducing-signals/\">https://preactjs.com/blog/introducing-signals/</a></p>\n</blockquote>\n<p><em>시그널은 앱이 복잡해져도 빠른 속도를 유지하도록 하는 상태 표현 방식입니다. 시그널은 반응형 원칙에 기반을 두고 있으며, 가상 돔에 최적화된 독특한 구현을 통해 개발자에게 훌륭한 경험을 제공합니다.</em></p>\n<p>본질적으로 시그널은 특정 값을 가지고 있는 <code>.value</code> 속성을 가진 객체입니다. 컴포넌트 내에서 시그널의 value 속성에 접근하면, 그 시그널의 값이 변경될 때 해당 컴포넌트가 자동으로 업데이트됩니다.</p>\n<p>이는 간단하고 작성하기 쉬울 뿐만 아니라, 앱이 얼마나 많은 컴포넌트를 가지고 있든 상태 업데이트가 빠르게 유지되도록 보장합니다. 시그널은 기본적으로 빠르며, 백그라운드에서 자동으로 업데이트를 최적화해줍니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"jsx\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">signal</span><span class=\"mtk1\">, </span><span class=\"mtk12\">computed</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&quot;@preact/signals&quot;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">signal</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">double</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">computed</span><span class=\"mtk1\">(() </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">2</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Counter</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">button</span><span class=\"mtk1\"> </span><span class=\"mtk12\">onClick</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk1\">() </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">++</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">{</span><span class=\"mtk12\">count</span><span class=\"mtk4\">}</span><span class=\"mtk1\"> x 2 = </span><span class=\"mtk4\">{</span><span class=\"mtk12\">double</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk4\">button</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><a href=\"https://preactjs.com/repl?code=import%20%7B%20render%20%7D%20from%20%22preact%22%3B%0A%0Aimport%20%7B%20signal%2C%20computed%20%7D%20from%20%22%40preact%2Fsignals%22%3B%0A%0Aconst%20count%20%3D%20signal(0)%3B%0Aconst%20double%20%3D%20computed(()%20%3D%3E%20count.value%20*%202)%3B%0A%0Afunction%20Counter()%20%7B%0A%20%20return%20(%0A%20%20%20%20%3Cbutton%20onClick%3D%7B()%20%3D%3E%20count.value%2B%2B%7D%3E%0A%20%20%20%20%20%20%7Bcount%7D%20x%202%20%3D%20%7Bdouble%7D%0A%20%20%20%20%3C%2Fbutton%3E%0A%20%20)%3B%0A%7D%0A%0Arender(%3CCounter%20%2F%3E%2C%20document.getElementById(%22app%22))%3B%0A\"><em>REPL에서 실행</em></a></p>\n<p>시그널은 훅과 달리 컴포넌트 내부 또는 외부에서 사용할 수 있습니다. 또한 시그널은 훅과 클래스 컴포넌트 <strong>모두</strong>에서 훌륭하게 작동하므로, 기존 지식을 활용하며 자신의 속도에 맞게 시그널을 도입할 수 있습니다. 몇몇 컴포넌트에서 시그널을 시도해보고 점진적으로 채택해보세요.</p>\n<p>아 그리고, 저희는 가능한 한 작은 라이브러리를 제공한다는 기본적인 철학에 충실하고 있습니다. Preact에서 시그널을 사용하더라도 번들 크기는 단 <strong>1.6kB</strong>만 증가합니다.</p>\n<p>당장 사용해보고 싶나요? 그렇다면 저희 <a href=\"https://preactjs.com/guide/v10/signals\">문서</a>를 읽고 시그널에 대해서 깊이 알아보세요.</p>\n<h2 id=\"시그널은-어떤-문제를-해결했나요\" style=\"position:relative;\"><a href=\"#%EC%8B%9C%EA%B7%B8%EB%84%90%EC%9D%80-%EC%96%B4%EB%96%A4-%EB%AC%B8%EC%A0%9C%EB%A5%BC-%ED%95%B4%EA%B2%B0%ED%96%88%EB%82%98%EC%9A%94\" aria-label=\"시그널은 어떤 문제를 해결했나요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>시그널은 어떤 문제를 해결했나요?</h2>\n<p>지난 몇 년 동안, 저희는 소규모 스타트업부터 수백 명의 개발자가 동시에 커밋하는 거대 기업에 이르기까지 다양한 앱 그리고 팀과 협력해 왔습니다. 이 기간 동안, 코어 팀의 모든 구성원은 애플리케이션 상태 관리 방식에 반복되는 문제가 있음을 발견했습니다.</p>\n<p>이러한 문제를 해결하기 위한 뛰어난 솔루션들이 만들어졌지만, 최고의 솔루션 조차도 여전히 프레임워크에 수동으로 통합(integration)해야 한다는 단점이 있었습니다. 그 결과, 개발자들은 이러한 솔루션들을 채택하는 데 주저함을 보였고, 대신 프레임워크에서 제공하는 상태 기본 요소들을 사용하여 구축하는 것을 선호했습니다.</p>\n<p>우리는 최적의 성능과 개발자 사용성을 결합하여 프레임워크와의 원활한 통합까지 갖추고 있는 매력적인 솔루션을 제공하고자 했습니다.</p>\n<h2 id=\"전역-상태에-대한-고민\" style=\"position:relative;\"><a href=\"#%EC%A0%84%EC%97%AD-%EC%83%81%ED%83%9C%EC%97%90-%EB%8C%80%ED%95%9C-%EA%B3%A0%EB%AF%BC\" aria-label=\"전역 상태에 대한 고민 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>전역 상태에 대한 고민</h2>\n<p>애플리케이션 상태는 일반적으로 작고 단순하며, 아마 몇 개의 간단한 <code>useState</code> 훅을 사용하는 것으로 시작됩니다. 앱이 커지고 더 많은 컴포넌트들이 동일한 상태에 접근할 필요가 생기면, 결국 그 상태는 공통의 부모 컴포넌트로 옮겨집니다. 이 패턴은 대부분의 상태가 컴포넌트 트리의 루트에 가깝게 관리될 때까지 여러 번 반복됩니다.</p>\n<p><img src=\"https://preactjs.com/assets/signals/state-updates.png\" alt=\"\"></p>\n<p>이 시나리오는 상태 무효화(invalidation)의 영향을 받는 전체 트리를 업데이트해야 하기 때문에 기존 가상 돔 기반 프레임워크에 도전 과제를 제시합니다. 본질적으로, 렌더링 성능은 그 트리에 있는 컴포넌트 수에 영향을 받습니다. 프레임 워크가 동일한 객체를 수신하도록 <code>memo</code>나 <code>useMemo</code>를 사용하여 컴포넌트 트리의 일부를 메모하여 이 문제를 해결할 수 있습니다. 변경된 사항이 없으면, 프레임워크가 트리의 일부 렌더링을 건너뛸 수 있습니다.</p>\n<p>이론적으로는 합리적으로 들리지만, 현실은 훨씬 더 혼란스러운 경우가 많습니다. 실제로, 코드베이스가 커짐에 따라 이러한 최적화를 어디에 적용해야 할지 어려워집니다. 종종, 좋은 의도의 메모이제이션조차도 불안정한 의존성 값으로 인해 비효율적인 경우가 있습니다. 훅은 분석할 수 있는 명시적인 의존성 트리를 가지고 있지 않기 때문에, 도구를 사용하여 개발자가 <em><strong>왜</strong></em> 의존성이 불안정한지 진단하는 데 도움을 주지 못합니다.</p>\n<h2 id=\"혼돈의-컨텍스트\" style=\"position:relative;\"><a href=\"#%ED%98%BC%EB%8F%88%EC%9D%98-%EC%BB%A8%ED%85%8D%EC%8A%A4%ED%8A%B8\" aria-label=\"혼돈의 컨텍스트 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>혼돈의 컨텍스트</h2>\n<p>상태 공유를 위해 팀들이 자주 사용하는 또 다른 일반적인 해결책은 상태를 컨텍스트에 넣는 것입니다. 이 방법은 컨텍스트 제공자(context provider)와 소비자(consumers) 사이의 컴포넌트들에 대한 렌더링을 건너뛰는 것을 가능하게 함으로써 불필요한 렌더링을 방지할 수 있습니다. 하지만 문제가 있습니다. 컨텍스트 제공자에게 전달된 값만 업데이트할 수 있고, 전체적으로만 업데이트 할 수 있습니다. 컨텍스트를 통해 노출된 객체의 속성을 업데이트해도 그 컨텍스트의 소비자들은 업데이트되지 않습니다. 즉, 세밀한 업데이트가 불가능합니다. 이를 처리하기 위해 사용할 수 있는 옵션들은 상태를 여러 컨텍스트로 나누거나, 그 속성 중 하나라도 변경될 때마다 컨텍스트 객체를 복제하여 과도하게 무효화하는 것입니다.</p>\n<p><img src=\"https://preactjs.com/assets/signals/context-chaos.png\" alt=\"\"></p>\n<p>컨텍스트로 값을 이동시키는 것이 처음에는 유리한 선택처럼 보일 수 있지만, 단지 값을 공유하기 위해 컴포넌트 트리의 크기를 증가시키는 것은 결국 문제가 됩니다. 비즈니스 로직은 필연적으로 여러 컨텍스트 값에 따라 달라지며, 이로 인해 트리의 특정 위치에 로직이 구현되도록 강제할 수 있습니다. 트리 중간에 컨텍스트를 구독하는 컴포넌트를 추가하면 컨텍스트를 업데이트할 때 건너뛸 수 있는 컴포넌트의 수가 줄어들기 때문에 비용이 많이 듭니다. 게다가 구독자 아래에 있는 모든 컴포넌트는 이제 다시 렌더링되어야 합니다. 이 문제에 대한 유일한 해결책은 메모이제이션을 열심히 적용하는 것인데, 이는 메모이제이션의 본질적인 문제가 우리를 다시 원점으로 돌려 놓습니다.</p>\n<h2 id=\"더-나은-상태-관리-방법에-대한-연구\" style=\"position:relative;\"><a href=\"#%EB%8D%94-%EB%82%98%EC%9D%80-%EC%83%81%ED%83%9C-%EA%B4%80%EB%A6%AC-%EB%B0%A9%EB%B2%95%EC%97%90-%EB%8C%80%ED%95%9C-%EC%97%B0%EA%B5%AC\" aria-label=\"더 나은 상태 관리 방법에 대한 연구 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>더 나은 상태 관리 방법에 대한 연구</h2>\n<p>우리는 차세대 상태 기본 요소(primitive)를 찾기 위해 다시 처음으로 돌아갔습니다. 우리는 현재 솔루션들의 문제점을 동시에 해결할 수 있는 무언가를 만들고 싶었습니다. 수동 프레임워크 통합, 메모이제이션에 대한 과도한 의존, 최적화 되지 않은 컨텍스트의 사용, 프로그래밍적으로 관찰하기에 어렵다는 점이 문제로 느껴졌습니다.</p>\n<p>개발자들은 이러한 전략(메모이제이션, 컨텍스트 최적화 등)을 통해 성능을 향상시키기 위해 추가적인 노력을 기울여야 합니다. 만약 우리가 이 접근법을 전환하여 <strong>기본적으로 빠른</strong> 시스템을 제공할 수 있다면 어떨까요? 성능 최적화가 기본적으로 내장된 시스템을 만들 수 있다면요?</p>\n<p>이러한 질문에 대한 답은 시그널 입니다. 앱 전반에 걸쳐 메모이제이션이나 트릭을 요구하지 않는 기본적으로 빠른 시스템 입니다. 시그널은 상태가 전역적이거나, props나 컨텍스트를 통해 전달되거나, 컴포넌트 내부에 국한되었는지와 상관없이 세밀한 상태 업데이트의 이점을 제공합니다.</p>\n<h2 id=\"미래를-향한-시그널\" style=\"position:relative;\"><a href=\"#%EB%AF%B8%EB%9E%98%EB%A5%BC-%ED%96%A5%ED%95%9C-%EC%8B%9C%EA%B7%B8%EB%84%90\" aria-label=\"미래를 향한 시그널 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>미래를 향한 시그널</h2>\n<p>시그널의 주요 아이디어는 컴포넌트 트리를 통해 값을 직접 전달하는 대신, 값이 포함된 시그널 객체(<code>ref</code>와 유사)를 전달하는 것입니다. 시그널의 값이 변경되어도 시그널 자체는 그대로 유지됩니다. 결과적으로 컴포넌트는 시그널의 값이 아니라 시그널을 보고 있기 때문에 구독한 컴포넌트들을 다시 렌더링하지 않고도 시그널을 업데이트할 수 있습니다. 이를 통해 컴포넌트들을 렌더링하는 비용이 많이 드는 작업을 모두 건너뛰고 실제로 시그널의 값에 접근하는 컴포넌트로 바로 이동할 수 있습니다.</p>\n<p><img src=\"https://preactjs.com/assets/signals/signals-update.png\" alt=\"\"></p>\n<p>우리는 애플리케이션의 상태 그래프가 일반적으로 컴포넌트 트리보다 훨신 간단하다는 사실을 활용하고 있습니다. 상태 그래프를 업데이트하는 데 필요한 작업이 컴포넌트 트리를 업데이트하는 것보다 훨씬 적기 때문에 렌더링이 더 빨라집니다. 이 차이는 브라우저에서 측정할 때 가장 명확하게 드러납니다. 아래 스크린샷은 동일한 앱에 대해 두 번 측정된 DevTools 프로파일 추적을 보여줍니다. 한 번은 상태 기본 요소로 훅을 사용하여 측정하고 다른 한 번은 시그널을 사용하였습니다.</p>\n<p><img src=\"https://preactjs.com/assets/signals/virtual-dom-vs-signals-update.png\" alt=\"\"></p>\n<p>시그널 버전은 전통적인 가상 돔 기반 프레임워크의 업데이트 메커니즘보다 성능이 훨씬 뛰어납니다. 우리가 테스트한 일부 앱에서는 시그널이 너무 빨라 *플레임그래프(flamegraph)에서 찾기가 어려울 정도입니다.</p>\n<p>시그널은 성능에 관한 관점을 완전히 뒤집어 놓습니다. 메모이제이션 또는 셀렉터를 통한 성능 최적화 대신, 시그널은 기본적으로 빠릅니다. 시그널을 사용하면, 성능 최적화가 기본적으로 활성화되어 있으며 최적화를 하지 않고자 할 때는 별도의 조치(시그널을 사용하지 않음)를 취해야 합니다.</p>\n<p>이러한 수준의 성능을 내기 위해, 시그널은 다음과 같은 핵심 원칙들을 바탕으로 구축되었습니다.</p>\n<ul>\n<li><strong>기본적으로 지연 처리:</strong> 현재 어딘가에서 사용되는 시그널만 관찰되고 업데이트되며, 연결되지 않은 시그널은 성능에 영향을 미치지 않습니다.</li>\n<li><strong>최적의 업데이트:</strong> 시그널의 값이 변하지 않았다면, 해당 시그널의 값을 사용하는 컴포넌트와 effect는 시그널의 의존성이 변경되었더라도 업데이트되지 않습니다.</li>\n<li><strong>최적의 의존성 추적:</strong> 프레임워크는 모든 것이 의존하는 시그널을 대신 추적해줍니다. 훅과 같은 의존성 배열이 필요하지 않습니다.</li>\n<li><strong>직접 접근:</strong> 컴포넌트에서 시그널의 값을 접근하는 것만으로도 셀렉터나 훅 없이 자동으로 업데이트를 구독하게 됩니다.</li>\n</ul>\n<p>이러한 원칙들은 시그널을 광범위한 사용 사례, 심지어 UI 렌더링과 관련없는 시나리오에도 적합하게 만듭니다.</p>\n<p><em>* 역자주: Flamegraph는 소프트웨어 성능 분석 도구 중 하나로, 프로그램의 실행 시간 동안 발생하는 다양한 함수 호출과 그 실행 시간을 시각화하는 그래프입니다.</em></p>\n<h2 id=\"preact에-시그널-가져오기\" style=\"position:relative;\"><a href=\"#preact%EC%97%90-%EC%8B%9C%EA%B7%B8%EB%84%90-%EA%B0%80%EC%A0%B8%EC%98%A4%EA%B8%B0\" aria-label=\"preact에 시그널 가져오기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Preact에 시그널 가져오기</h2>\n<p>올바른 상태 기본 요소를 확인한 후, 우리는 그것을 Preact에 연결하기 시작했습니다. 우리가 항상 훅을 좋아하는 이유는 컴포넌트 내에서 직접 사용할 수 있다는 점입니다. 이는 “셀렉터” 함수에 의존하거나 컴포넌트를 특별한 함수로 감싸서 상태 업데이트를 구독하는 것과 같은 써드 파티 상태 관리 솔루션들에 비해 사용성이 우수하다는 장점이 있습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"jsx\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 셀렉터 기반 구독 :(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Counter</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">useSelector</span><span class=\"mtk1\">(</span><span class=\"mtk12\">state</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">state</span><span class=\"mtk1\">.</span><span class=\"mtk12\">count</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 래퍼 함수 기반 구독 :(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">counterState</span><span class=\"mtk1\"> = </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Counter</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Counter</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">observe</span><span class=\"mtk1\">(</span><span class=\"mtk12\">props</span><span class=\"mtk1\"> </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">counterState</span><span class=\"mtk1\">.</span><span class=\"mtk12\">count</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk3\">// ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">});</span></span></span></code></pre>\n<p>두 가지 접근 방식 모두 우리에게 만족스럽지 않았습니다. 셀렉터 접근 방식은 모든 상태 접근을 셀렉터로 감싸야 하며, 이는 복잡하거나 중첩된 상태에서는 번거로워집니다. 컴포넌트를 함수로 감싸는 방식은 컴포넌트를 수동으로 감싸야 하는 노력이 필요하며, 이는 컴포넌트 이름과 정적 프로퍼티가 누락되는 등의 여러 문제를 가져옵니다.</p>\n<p>지난 몇 년 동안 우리는 많은 개발자들과 긴밀하게 협력할 기회를 가졌습니다. 특히 (P)react를 처음 접하는 사람들의 일반적인 어려움 중 하나는 셀렉터나 래퍼와 같은 개념들이 추가적인 패러다임으로 여겨져, 각 상태 관리 솔루션의 생산성을 느껴보기 전에 이러한 개념들을 먼저 배워야 하는 부담이 있습니다.</p>\n<p>이상적으로는 셀렉터나 래퍼 함수에 대해 알 필요 없으며 단순히 컴포넌트 내에서 직접 상태에 접근할 수 있습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"jsx\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 이것이 전역 상태이고 전체 앱에서 이에 접근해야 하는 상황을 상상해보세요.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">let</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk7\">0</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Counter</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">button</span><span class=\"mtk1\"> </span><span class=\"mtk12\">onClick</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk1\">() </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\">++</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     value: </span><span class=\"mtk4\">{</span><span class=\"mtk12\">count</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk4\">button</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>코드는 명확하고 이해하기 쉽지만, 불행히도 작동하지 않습니다. 버튼을 클릭할 때 컴포넌트가 업데이트되지 않는데, 이는 <code>count</code>가 변경되었다는 것을 알 수 있는 방법이 없기 때문입니다.</p>\n<p>하지만 우리는 이 시나리오를 머릿속에서 지울 수 없었습니다. 이렇게 명확한 모델을 현실로 만들기 위해 우리는 무엇을 할 수 있을까요? 우리는 Preact의 <a href=\"https://preactjs.com/guide/v10/options\">pluggable 렌더러</a>를 사용하여 다양한 아이디어와 구현 방법을 프로토타이핑 해보기 시작했습니다. 시간이 걸렸지만, 결국 그것을 실현시킬 수 있는 방법을 찾아냈습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"jsx\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 이것이 전역 상태이고 전체 앱에서 이에 접근해야 하는 상황을 상상해보세요.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">signal</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Counter</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">button</span><span class=\"mtk1\"> </span><span class=\"mtk12\">onClick</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk1\">() </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk1\">++</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     Value: </span><span class=\"mtk4\">{</span><span class=\"mtk12\">count</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">   </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk4\">button</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\"> );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span></code></pre>\n<p><a href=\"https://preactjs.com/repl?code=import%20%7B%20render%20%7D%20from%20%22preact%22%3B%0Aimport%20%7B%20signal%20%7D%20from%20%22%40preact%2Fsignals%22%3B%0A%0A%2F%2F%20Imagine%20this%20is%20some%20global%20state%20that%20the%20whole%20app%20needs%20access%20to%3A%0Aconst%20count%20%3D%20signal(0)%3B%0A%0Afunction%20Counter()%20%7B%0A%20return%20(%0A%20%20%20%3Cbutton%20onClick%3D%7B()%20%3D%3E%20count.value%2B%2B%7D%3E%0A%20%20%20%20%20Value%3A%20%7Bcount.value%7D%0A%20%20%20%3C%2Fbutton%3E%0A%20)%3B%0A%7D%0A%0Arender(%3CCounter%20%2F%3E%2C%20document.getElementById(%22app%22))%3B%0A\"><em>REPL에서 실행</em></a></p>\n<p>셀렉터도, 래퍼 함수도, 아무 것도 없습니다. 시그널의 값에 접근하는 것만으로도 컴포넌트가 해당 시그널의 값이 변경될 때 업데이트해야 한다는 것을 알 수 있습니다. 몇몇 앱에서 프로토타입을 테스트해본 후, 우리는 무언가를 해냈다는 것이 분명해졌습니다. 이런 방식으로 코드를 작성하는 것은 직관적이었고, 최적의 상태로 작동시키기 위해 복잡한 생각을 할 필요가 없었습니다.</p>\n<h2 id=\"더-빠르게-할-수-있을까요\" style=\"position:relative;\"><a href=\"#%EB%8D%94-%EB%B9%A0%EB%A5%B4%EA%B2%8C-%ED%95%A0-%EC%88%98-%EC%9E%88%EC%9D%84%EA%B9%8C%EC%9A%94\" aria-label=\"더 빠르게 할 수 있을까요 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>더 빠르게 할 수 있을까요?</h2>\n<p>여기서 멈출 수도 있었고, 시그널을 그대로 출시할 수도 있었지만, 우리는 Preact 팀입니다. 우리는 Preact 통합을 얼마나 더 밀어붙일 수 있는지 보고 싶었습니다. 위의 카운터 예제에서, <code>count</code>의 값은 텍스트를 표시하는 데만 사용되는데, 이것이 전체 컴포넌트를 다시 렌더링할 필요는 정말 없어야 합니다. 시그널의 값이 변경될 때 자동으로 컴포넌트를 리렌더링하는 대신, 텍스트만 다시 렌더링하는 것은 어떨까요? 더 나아가, 가상 돔을 완전히 우회하여 텍스트를 돔에서 직접 업데이트한다면 어떨까요?</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"jsx\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">count</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">signal</span><span class=\"mtk1\">(</span><span class=\"mtk7\">0</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// 아래처럼 하지 않고</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">p</span><span class=\"mtk17\">&gt;</span><span class=\"mtk1\">Value: </span><span class=\"mtk4\">{</span><span class=\"mtk12\">count</span><span class=\"mtk1\">.</span><span class=\"mtk12\">value</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&lt;/</span><span class=\"mtk4\">p</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// … 우리는 시그널을 직접 JSX에 전달할 수 있습니다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">p</span><span class=\"mtk17\">&gt;</span><span class=\"mtk1\">Value: </span><span class=\"mtk4\">{</span><span class=\"mtk12\">count</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&lt;/</span><span class=\"mtk4\">p</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// … 또는 돔 속성으로도 전달할 수 있습니다.</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">input</span><span class=\"mtk1\"> </span><span class=\"mtk12\">value</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk12\">count</span><span class=\"mtk4\">}</span><span class=\"mtk1\"> </span><span class=\"mtk12\">onInput</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk1\">...</span><span class=\"mtk4\">}</span><span class=\"mtk1\"> </span><span class=\"mtk17\">/&gt;</span></span></span></code></pre>\n<p>그래서, 네. 그렇게 했습니다. 문자열을 일반적으로 사용하는 어떤 곳이든 JSX에 직접 시그널을 전달할 수 있습니다. 시그널의 값은 텍스트로 렌더링되며, 시그널이 변경될 때 자동으로 스스로를 업데이트합니다. 이는 props에도 적용됩니다</p>\n<h2 id=\"다음-스텝\" style=\"position:relative;\"><a href=\"#%EB%8B%A4%EC%9D%8C-%EC%8A%A4%ED%85%9D\" aria-label=\"다음 스텝 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>다음 스텝</h2>\n<p>궁금하고 바로 시작해보시려면, 시그널 <a href=\"https://preactjs.com/guide/v10/signals\">문서</a>를 확인해보세요. 여러분이 어떻게 사용할지 듣고 싶습니다.</p>\n<p>시그널로 전환하는 것에 서두를 필요는 없다는 것을 기억하세요. 훅은 계속 지원될 것이며, 시그널과 함께 사용해도 훌륭하게 작동합니다! 개념에 익숙해지기 위해 몇 개의 컴포넌트로 시작하여 시그널을 점진적으로 시도해보는 것을 추천합니다.</p>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .default-dark .mtk15 { color: #C586C0; }\n  .default-dark .mtk1 { color: #D4D4D4; }\n  .default-dark .mtk12 { color: #9CDCFE; }\n  .default-dark .mtk8 { color: #CE9178; }\n  .default-dark .mtk4 { color: #569CD6; }\n  .default-dark .mtk11 { color: #DCDCAA; }\n  .default-dark .mtk7 { color: #B5CEA8; }\n  .default-dark .mtk17 { color: #808080; }\n  .default-dark .mtk3 { color: #6A9955; }\n  .default-dark .mtk10 { color: #4EC9B0; }\n  .default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"date":"November 27, 2023","title":"(번역) 시그널(Signal)에 대한 소개","categories":"react","author":"soobing"},"fields":{"slug":"/react/introducing-signals/"}},"prev":{"id":"161feee4-18f2-5161-8900-a9bc5eda4367","html":"<p>지난 글에서 react-query의 hydrate, dehydrate을 통해 서버에서 prefetching 한 데이터 사용하는 방법에 대해서 살펴보았습니다.</p>\n<blockquote>\n<p><a href=\"https://soobing.github.io/react/server-rendering-and-react-query/\">서버에서 prefetching 한 데이터 사용하기</a></p>\n</blockquote>\n<p>오늘은 조금 실용적으로 Next.js 13, 14 버전의 app router에서 react-query를 어떻게 사용하고 세팅하면 좋을지 고민했던 내용에 대해서 이야기해보도록 하겠습니다.</p>\n<blockquote>\n<p>해당 글은 23년 10월에 메이저 버전 업데이트된, <a href=\"https://nextjs.org/blog/next-14\">Next.js 14</a>와 <a href=\"https://tanstack.com/blog/announcing-tanstack-query-v5\">React-Query 5</a> 를 기준으로 작성된 글입니다.</p>\n</blockquote>\n<blockquote>\n<p>예시로 보여주는 코드는 저의 <a href=\"https://github.com/soobing/next-14-react-query\">next-14-react-query</a> repo에서 확인 할 수 있습니다.</p>\n</blockquote>\n<p>제가 크게 고민했던 문제는 아래 세 가지입니다.</p>\n<ul>\n<li><code>Hydrate</code> vs <code>ReactQueryStreamedHydration</code> 두 가지 API 중에 어떤 것을 채택할까?</li>\n<li>Hydration API 사용 시에 RSC, RCC 모두에서 깔끔한 코드를 유지하려면 queryOption은 어떻게 정의하는 게 좋을까?</li>\n<li><code>dehydrate(queryClient).queries</code>에는 현재 기준 prefetch 된(?) 모든 쿼리들이 다 따라온다 😱</li>\n</ul>\n<p><a href=\"https://jsonplaceholder.typicode.com/\">jsonplaceholder API</a> 서버의 photo 서비스를 사용하는 것을 예시로 프로젝트 구조를 어떻게 설계했는지, 그리고 위에서 했던 고민들에 대한 이야기를 나눠 보도록 하겠습니다.</p>\n<h2 id=\"초기-환경-세팅\" style=\"position:relative;\"><a href=\"#%EC%B4%88%EA%B8%B0-%ED%99%98%EA%B2%BD-%EC%84%B8%ED%8C%85\" aria-label=\"초기 환경 세팅 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>초기 환경 세팅</h2>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"0\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/** hooks/useReactQuery.tsx */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk8\">&#39;use client&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">useState</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;react&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">QueryClient</span><span class=\"mtk1\">, </span><span class=\"mtk12\">QueryClientProvider</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@tanstack/react-query&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">ReactQueryDevtools</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@tanstack/react-query-devtools&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">ReactQueryProviders</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">children</span><span class=\"mtk1\"> }: </span><span class=\"mtk10\">React</span><span class=\"mtk1\">.</span><span class=\"mtk10\">PropsWithChildren</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">] = </span><span class=\"mtk11\">useState</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    () </span><span class=\"mtk4\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">QueryClient</span><span class=\"mtk1\">({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk12\">defaultOptions:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          </span><span class=\"mtk12\">queries:</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// With SSR, we usually want to set some default staleTime</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk3\">// above 0 to avoid refetching immediately on the client</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">            </span><span class=\"mtk12\">staleTime:</span><span class=\"mtk1\"> </span><span class=\"mtk7\">60</span><span class=\"mtk1\"> * </span><span class=\"mtk7\">1000</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">          },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        },</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      }),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">QueryClientProvider</span><span class=\"mtk1\"> </span><span class=\"mtk12\">client</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk12\">queryClient</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">{</span><span class=\"mtk12\">children</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">ReactQueryDevtools</span><span class=\"mtk1\"> </span><span class=\"mtk12\">initialIsOpen</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{false}</span><span class=\"mtk1\"> </span><span class=\"mtk17\">/&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk10\">QueryClientProvider</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"1\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/** app/layout.tsx */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">ReactQueryProviders</span><span class=\"mtk1\"> </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/hooks/useReactQuery&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">RootLayout</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">children</span><span class=\"mtk1\"> }: </span><span class=\"mtk10\">React</span><span class=\"mtk1\">.</span><span class=\"mtk10\">PropsWithChildren</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">html</span><span class=\"mtk1\"> </span><span class=\"mtk12\">lang</span><span class=\"mtk1\">=</span><span class=\"mtk8\">&quot;en&quot;</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">head</span><span class=\"mtk1\"> </span><span class=\"mtk17\">/&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">body</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">        </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">ReactQueryProviders</span><span class=\"mtk17\">&gt;</span><span class=\"mtk4\">{</span><span class=\"mtk12\">children</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&lt;/</span><span class=\"mtk10\">ReactQueryProviders</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk4\">body</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk4\">html</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<h2 id=\"클라이언트-서버-모두에서-사용될-수-있도록-서비스-설계하기\" style=\"position:relative;\"><a href=\"#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8-%EC%84%9C%EB%B2%84-%EB%AA%A8%EB%91%90%EC%97%90%EC%84%9C-%EC%82%AC%EC%9A%A9%EB%90%A0-%EC%88%98-%EC%9E%88%EB%8F%84%EB%A1%9D-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%84%A4%EA%B3%84%ED%95%98%EA%B8%B0\" aria-label=\"클라이언트 서버 모두에서 사용될 수 있도록 서비스 설계하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>클라이언트, 서버 모두에서 사용될 수 있도록 서비스 설계하기</h2>\n<p><a href=\"https://jsonplaceholder.typicode.com/\">jsonplaceholder API</a> 페이지를 가보면, 서비스 별로 다음과 같은 라우터 구조를 가지고 있다고 명세되어 있습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 76.66666666666666%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAABXUlEQVQ4y6VTy26DMBDk/z8qyiWHXCmKI4JoK97hZV41EMhUY4mojXqAdKWVV7Z3vOOdNXa7HY7HIw6HA/b7Pdq2BW2eZ9zv981uBEEA13XhOI72aZrwHzPquoaUEk3ToCgKpGmKLMuQJAniONZxnuePs+v1qveiKNL7jOlhGEIpBaOqKk2TK0GYSGciAfhgWZbaub/EBGMhy33m9n0Po+s6jU6bphmO+4EvpV6nTKr8RxqBTEvAD6NflzY15SegUj3E+QLbcRGEMd4/PZSyeoCurnChzArPtoOTsGGdznizhAZfwNaAGmwIZXO73fSn2pcL0jRD03aQVY26brYDLhUSkFpkF59tNWV22fd9jOOIYRgghNAae27G6gqpM9M0tY5U3+vY87zXAXmJAiVdGumqP3S4mjLpcnRKKeEH0UP9rJiTQvr8itUVcl6ZnOcFojhBXhT6gWVmebYF8BtlF4wWzsFQogAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/360e9dafd9cbae4c0b206e41fb05ed71/37523/1.png\"\n        srcset=\"/static/360e9dafd9cbae4c0b206e41fb05ed71/e9ff0/1.png 180w,\n/static/360e9dafd9cbae4c0b206e41fb05ed71/f21e7/1.png 360w,\n/static/360e9dafd9cbae4c0b206e41fb05ed71/37523/1.png 720w,\n/static/360e9dafd9cbae4c0b206e41fb05ed71/302a4/1.png 1080w,\n/static/360e9dafd9cbae4c0b206e41fb05ed71/84bf8/1.png 1162w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>저는 photo 서비스를 기준으로 아래와 같이 폴더를 생성해 보았습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 642px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.888888888888886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA8ElEQVQoz52S226FIBRE/QcV8AZSq1LjpV5AjfH/P2tO4DQnbfpQ7cPAflrMDNuL4xhFUaDveyc7E0LAGPuXPHsUxTvmeXYqy/IXkFJ6D5ilKaZpgtYaeZ7D930HDcPwBbfQK2CPEoJISKhugNEay7Jg33f3wLqu6LruVgUOGAuJt0rhcxigjXEwG11KCSHED2d/ufQofQKrpnUO52VxXVpYEAS3YF8OQ0Q8h6wUVqNhjME4jjjPE8dxuNjbtoFzfim6x6IYvPxwMW1/9rbrk2UZ7EolSYI0Ta87ZCxCIiSapkFd12jbFkqp169+15UOH3Y/8kt4v2AQAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/a594c1531d9f0cb51f3dc6c58dbf115b/1bba8/2.png\"\n        srcset=\"/static/a594c1531d9f0cb51f3dc6c58dbf115b/e9ff0/2.png 180w,\n/static/a594c1531d9f0cb51f3dc6c58dbf115b/f21e7/2.png 360w,\n/static/a594c1531d9f0cb51f3dc6c58dbf115b/1bba8/2.png 642w\"\n        sizes=\"(max-width: 642px) 100vw, 642px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>API의 서비스별로 따로 관리하면 가독성과 유지 보수에 좋습니다. 그래서 PhotoService를 작성하면 아래와 같습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"2\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/** service/photo/PhotoService.ts */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Service</span><span class=\"mtk1\"> </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/service/Service&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">Photo</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/model/photo&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">class</span><span class=\"mtk1\"> </span><span class=\"mtk10\">PhotoService</span><span class=\"mtk1\"> </span><span class=\"mtk4\">extends</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Service</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">getPhotos</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">http</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Photo</span><span class=\"mtk1\">[]&gt;(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">`/photos`</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">getPhoto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">http</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Photo</span><span class=\"mtk1\">&gt;(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">`/photo/</span><span class=\"mtk4\">${</span><span class=\"mtk12\">photoId</span><span class=\"mtk4\">}</span><span class=\"mtk8\">`</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">getComments</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">http</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Comment</span><span class=\"mtk1\">[]&gt;(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">`/photo/</span><span class=\"mtk4\">${</span><span class=\"mtk12\">photoId</span><span class=\"mtk4\">}</span><span class=\"mtk8\">/comments`</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">getComment</span><span class=\"mtk1\">({</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">}: {</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">}) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk4\">this</span><span class=\"mtk1\">.</span><span class=\"mtk12\">http</span><span class=\"mtk1\">.</span><span class=\"mtk11\">get</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Comment</span><span class=\"mtk1\">[]&gt;(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk8\">`/photo/</span><span class=\"mtk4\">${</span><span class=\"mtk12\">photoId</span><span class=\"mtk4\">}</span><span class=\"mtk8\">/comments/</span><span class=\"mtk4\">${</span><span class=\"mtk12\">commentId</span><span class=\"mtk4\">}</span><span class=\"mtk8\">`</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">PhotoService</span><span class=\"mtk1\">();</span></span></span></code></pre>\n<p>그리고 react-query의 useQuery를 사용 할 때, 필요한 곳에서 직접적으로 호출해서 사용하기보다는 이 또한 서비스별로 Colocate 시켜서 가독성과 유지 보수하기 좋도록 설계했습니다.</p>\n<blockquote>\n<p>관련해서 유명한 글인 <a href=\"https://kentcdodds.com/blog/colocation\">Maintainability through colocation</a> by <a href=\"https://twitter.com/kentcdodds\">Kent C. Dodds</a>를 읽어보는 것을 추천합니다.</p>\n</blockquote>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"3\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">/** service/photo/usePhotoService.ts */</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">useQuery</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@tanstack/react-query&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\"> </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/service/photo/queries&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">usePhotos</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">useQuery</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">usePhoto</span><span class=\"mtk1\">({</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">}: {</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">}) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">useQuery</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\">.</span><span class=\"mtk11\">detail</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">useComments</span><span class=\"mtk1\">({</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">}: {</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">}) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">useQuery</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\">.</span><span class=\"mtk11\">comments</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">useComment</span><span class=\"mtk1\">({</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">}: {</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">}) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">useQuery</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\">.</span><span class=\"mtk11\">comment</span><span class=\"mtk1\">({</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">}));</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>여기서 queries라는 파일에서 queryOption을 빼오고 있는데, 해당 파일에서는 QueryKey와 QueryOption을 모두 관리하고 있습니다. 이것은 react-query의 메인테이너인 TkDodo’s blog에서 효율적으로 <a href=\"https://tkdodo.eu/blog/effective-react-query-keys\">React Query Key 관리하는  법</a> 이라는 글을 참고하여 작성했습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"4\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PhotoService</span><span class=\"mtk1\"> </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/service/photo/PhotoService&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryKeys</span><span class=\"mtk1\"> = {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">all:</span><span class=\"mtk1\"> [</span><span class=\"mtk8\">&#39;photos&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk4\">const</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">detail</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> [...</span><span class=\"mtk12\">queryKeys</span><span class=\"mtk1\">.</span><span class=\"mtk12\">all</span><span class=\"mtk1\">, </span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">] </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk4\">const</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">detailComments</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> [...</span><span class=\"mtk12\">queryKeys</span><span class=\"mtk1\">.</span><span class=\"mtk11\">detail</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">), </span><span class=\"mtk8\">&#39;comments&#39;</span><span class=\"mtk1\">] </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk4\">const</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">detailComment</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> ({</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">}: {</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">}) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> [...</span><span class=\"mtk12\">queryKeys</span><span class=\"mtk1\">.</span><span class=\"mtk11\">detailComments</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">), </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">] </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk4\">const</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\"> = {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">all</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> ({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryKeys</span><span class=\"mtk1\">.</span><span class=\"mtk12\">all</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">queryFn</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PhotoService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPhotos</span><span class=\"mtk1\">(),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">detail</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> ({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryKeys</span><span class=\"mtk1\">.</span><span class=\"mtk11\">detail</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">queryFn</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PhotoService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getPhoto</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">comments</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> (</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> ({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryKeys</span><span class=\"mtk1\">.</span><span class=\"mtk11\">detailComments</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">queryFn</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PhotoService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getComments</span><span class=\"mtk1\">(</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">comment</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> ({</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">}: {</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">: </span><span class=\"mtk10\">number</span><span class=\"mtk1\">}) </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> ({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queryKey:</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryKeys</span><span class=\"mtk1\">.</span><span class=\"mtk11\">detailComment</span><span class=\"mtk1\">({</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">}),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">queryFn</span><span class=\"mtk12\">:</span><span class=\"mtk1\"> () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PhotoService</span><span class=\"mtk1\">.</span><span class=\"mtk11\">getComment</span><span class=\"mtk1\">({</span><span class=\"mtk12\">photoId</span><span class=\"mtk1\">, </span><span class=\"mtk12\">commentId</span><span class=\"mtk1\">}),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  }),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">};</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\">;</span></span></span></code></pre>\n<p>위의 글에서는 queryKey 관리에 대한 이야기만 나와있지만, SSR이나 RSC에서 Hydrate API를 사용하는 경우가 많아져서, queryKey와 비슷하게 queryOption도 함께 관리하도록 추가했습니다.</p>\n<h2 id=\"서버에서-prefetching-하고-데이터-dehydration-하기\" style=\"position:relative;\"><a href=\"#%EC%84%9C%EB%B2%84%EC%97%90%EC%84%9C-prefetching-%ED%95%98%EA%B3%A0-%EB%8D%B0%EC%9D%B4%ED%84%B0-dehydration-%ED%95%98%EA%B8%B0\" aria-label=\"서버에서 prefetching 하고 데이터 dehydration 하기 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>서버에서 Prefetching 하고 데이터 de/hydration 하기</h2>\n<p>hydration에 대한 개념적인 설명은 지난 글을 참고해 주시면 좋을것 같습니다. 서버에서 prefetch 한 쿼리들을 dehydrate 시켰다가 클라이언트에서 hydration 시켜줘야 합니다. 이렇게 해주면 서버에서 prefetch 하여 react-query로 캐싱 한 쿼리들을 클라이언트에서 사용할 때도 유지되어서 refetch 하지 않습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"5\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">HydrationBoundary</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">QueryClient</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">dehydrate</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">QueryState</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">QueryKey</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@tanstack/react-query&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">cache</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;react&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">isEqual</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/utils&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">getQueryClient</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">cache</span><span class=\"mtk1\">(() </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk4\">new</span><span class=\"mtk1\"> </span><span class=\"mtk10\">QueryClient</span><span class=\"mtk1\">());</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">type</span><span class=\"mtk1\"> </span><span class=\"mtk10\">UnwrapPromise</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">T</span><span class=\"mtk1\">&gt; = </span><span class=\"mtk10\">T</span><span class=\"mtk1\"> </span><span class=\"mtk4\">extends</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Promise</span><span class=\"mtk1\">&lt;</span><span class=\"mtk4\">infer</span><span class=\"mtk1\"> </span><span class=\"mtk10\">U</span><span class=\"mtk1\">&gt; ? </span><span class=\"mtk10\">U</span><span class=\"mtk1\"> : </span><span class=\"mtk10\">T</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">interface</span><span class=\"mtk1\"> </span><span class=\"mtk10\">QueryProps</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">ResponseType</span><span class=\"mtk1\"> = </span><span class=\"mtk10\">unknown</span><span class=\"mtk1\">&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">: </span><span class=\"mtk10\">QueryKey</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk11\">queryFn</span><span class=\"mtk1\">: () </span><span class=\"mtk4\">=&gt;</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Promise</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">ResponseType</span><span class=\"mtk1\">&gt;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk4\">interface</span><span class=\"mtk1\"> </span><span class=\"mtk10\">DehydratedQueryExtended</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">TData</span><span class=\"mtk1\"> = </span><span class=\"mtk10\">unknown</span><span class=\"mtk1\">, </span><span class=\"mtk10\">TError</span><span class=\"mtk1\"> = </span><span class=\"mtk10\">unknown</span><span class=\"mtk1\">&gt; {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">state</span><span class=\"mtk1\">: </span><span class=\"mtk10\">QueryState</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">TData</span><span class=\"mtk1\">, </span><span class=\"mtk10\">TError</span><span class=\"mtk1\">&gt;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getDehydratedQuery</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Q</span><span class=\"mtk1\"> </span><span class=\"mtk4\">extends</span><span class=\"mtk1\"> </span><span class=\"mtk10\">QueryProps</span><span class=\"mtk1\">&gt;({</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\">,</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}: </span><span class=\"mtk10\">Q</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getQueryClient</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prefetchQuery</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\"> });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">queries</span><span class=\"mtk1\"> } = </span><span class=\"mtk11\">dehydrate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">dehydratedQuery</span><span class=\"mtk1\">] = </span><span class=\"mtk12\">queries</span><span class=\"mtk1\">.</span><span class=\"mtk11\">filter</span><span class=\"mtk1\">((</span><span class=\"mtk12\">query</span><span class=\"mtk1\">) </span><span class=\"mtk4\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk11\">isEqual</span><span class=\"mtk1\">(</span><span class=\"mtk12\">query</span><span class=\"mtk1\">.</span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk12\">dehydratedQuery</span><span class=\"mtk1\"> </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk10\">DehydratedQueryExtended</span><span class=\"mtk1\">&lt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">UnwrapPromise</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">ReturnType</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Q</span><span class=\"mtk1\">[</span><span class=\"mtk8\">&#39;queryFn&#39;</span><span class=\"mtk1\">]&gt;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &gt;;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Hydrate</span><span class=\"mtk1\"> = </span><span class=\"mtk12\">HydrationBoundary</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> {};</span></span></span></code></pre>\n<p>위의 코드에서는 <code>getQueryClient</code>와 <code>getDehydratedQuery</code> 두 가지 함수를 유틸로 export 하고 있습니다. <code>getQueryClient</code> 유틸은 <a href=\"https://tanstack.com/query/latest/docs/react/guides/advanced-ssr#alternative-use-a-single-queryclient-for-prefetching\">공식 문서에서 권장</a> 하고 있듯이, 서버에서 데이터를 fetching 할 때 마다 필요한 queryClient를 cache 해서 사용할 수 있도록 했습니다.</p>\n<p><code>getDehydratedQuery</code>는 queryClient를 이용하여 서버에서 데이터를 prefetching 하고 dehydrate 한 결과물을 리턴하는 코드입니다.</p>\n<p>위 유틸을 사용하여 SSR을 수행하고 있는 page.tsx 파일에서 서버에서 prefeching 한 데이터를 hydration 시켰을 때 아래와 같이 inactive 상태로 보이는 것을 볼 수 있습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"6\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">Image</span><span class=\"mtk1\"> </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;next/image&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">styles</span><span class=\"mtk1\"> </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;./page.module.css&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">PhotoList</span><span class=\"mtk1\"> </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/components/PhotoList&#39;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\"> </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/service/photo/queries&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">Hydrate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">getDehydratedQuery</span><span class=\"mtk1\"> } </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/utils/react-query&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Home</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\"> } = </span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">query</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getDehydratedQuery</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\"> });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">main</span><span class=\"mtk1\"> </span><span class=\"mtk12\">className</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk12\">styles</span><span class=\"mtk1\">.</span><span class=\"mtk12\">main</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">{</span><span class=\"mtk3\">/* 서버 사이드 렌더링 &amp; 서버 컴포넌트 */</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">Hydrate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">state</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk1\">{ </span><span class=\"mtk12\">queries:</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">query</span><span class=\"mtk1\">] }</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">{</span><span class=\"mtk3\">/* Client Component 잠시 주석처리 */</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">{</span><span class=\"mtk3\">/* &lt;PhotoList/&gt; */</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk10\">Hydrate</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk4\">main</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.444444444444443%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAArUlEQVQY01WOSw7DIAwFc/8DdtNtqxDAQMCYTxevwpGqdDGyZT2PvT0fD9jDwLiI/SAYG1Clo/eJWAosRfjI2G3AbgkUGK/dg+IJ5zwsJfiQYH0E14aNDoPKjHheLKGjhFIbUmEVsnQNL6QNFBZI6xBpyCygmOHDqfPtbTwOdy2tz1JmhJQ1uKRnqWh9oI/5R1t1flSci2heP6yyLssvOOZH+VvuU6UX935c4htfIGszoYYKzU0AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/9e8685c928e2c32961adbe8d393c2250/37523/3.png\"\n        srcset=\"/static/9e8685c928e2c32961adbe8d393c2250/e9ff0/3.png 180w,\n/static/9e8685c928e2c32961adbe8d393c2250/f21e7/3.png 360w,\n/static/9e8685c928e2c32961adbe8d393c2250/37523/3.png 720w,\n/static/9e8685c928e2c32961adbe8d393c2250/302a4/3.png 1080w,\n/static/9e8685c928e2c32961adbe8d393c2250/07a9c/3.png 1440w,\n/static/9e8685c928e2c32961adbe8d393c2250/7db30/3.png 1494w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p><code>Hydrate</code> 내부의 <code>&#x3C;PhotoList/></code>를 주석 해제해 보면, Client 컴포넌트에서 동일한 쿼리를 요청했을 때 active 상태로 바뀌는 것을 볼 수 있습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"7\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Home</span><span class=\"mtk1\">() {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\"> } = </span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">query</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getDehydratedQuery</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\"> });</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk4\">main</span><span class=\"mtk1\"> </span><span class=\"mtk12\">className</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk12\">styles</span><span class=\"mtk1\">.</span><span class=\"mtk12\">main</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">     ...</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk4\">{</span><span class=\"mtk3\">/* 서버 사이드 렌더링 &amp; 서버 컴포넌트 */</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">Hydrate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">state</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk1\">{ </span><span class=\"mtk12\">queries:</span><span class=\"mtk1\"> [</span><span class=\"mtk12\">query</span><span class=\"mtk1\">] }</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">{</span><span class=\"mtk3\">/* Client Component 잠시 주석처리 */</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">PhotoList</span><span class=\"mtk17\">/&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk10\">Hydrate</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk4\">main</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 18.88888888888889%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAAm0lEQVQY04WOyQrDMAxE8/+/WHooDdSJF3nfepgiOwk9FHp4iBEzIy2P+w1CKKyrxPqUsBSRS0Uq9ZqSLIQ12MnjtSmQjRA7QRuC0gRlHKS20OSxeOcRYoYLaSw3aeAPTS6gtj5KJw0xFZTaEPM8yLCXS0fhthOs56+m2YeEmMsgHOFS+wUf4N2cU3PpmVlYlNbR+vsnHPjHt/8D5Mo0vXjyLjUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/f2dc2c528da71e3981f0b7264934b25d/37523/4.png\"\n        srcset=\"/static/f2dc2c528da71e3981f0b7264934b25d/e9ff0/4.png 180w,\n/static/f2dc2c528da71e3981f0b7264934b25d/f21e7/4.png 360w,\n/static/f2dc2c528da71e3981f0b7264934b25d/37523/4.png 720w,\n/static/f2dc2c528da71e3981f0b7264934b25d/302a4/4.png 1080w,\n/static/f2dc2c528da71e3981f0b7264934b25d/07a9c/4.png 1440w,\n/static/f2dc2c528da71e3981f0b7264934b25d/27f8b/4.png 1730w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>hydration이 제대로 된 것을 확인할 수 있습니다.</p>\n<p>사실 hydration 목적 이외에도 prefetching 한 response 데이터를 미리 접근해서 사용할 수도 있습니다. <code>query.state.data</code>  형태로 직접 접근하여 사용할 수 있습니다.</p>\n<p><code>dehydrate</code> 함수를 보면 queryClient로 prefetch된 모든 데이터를 전부 반환하므로 만약 필터링 없이 다음과 같이 모든 query를 리턴한다면 SSR을 하는 페이지 단에서, 그리고 내부에 서버 컴포넌트가 존재하는 경우 각각 dehydrate를 한다면해당 데이터를 미리 접근해서 사용하는 경우 순서를 알기 어려워 아래와 같이 유틸을 작성하지 않고 필터링하도록 구현했습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"8\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk3\">// [참고용] filtering 하지 않고 모든 dehydrated query를 반환하는 함수</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getDehydratedQueries</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Q</span><span class=\"mtk1\"> </span><span class=\"mtk4\">extends</span><span class=\"mtk1\"> </span><span class=\"mtk10\">QueryProps</span><span class=\"mtk1\">[]&gt;(</span><span class=\"mtk12\">queries</span><span class=\"mtk1\">: </span><span class=\"mtk10\">Q</span><span class=\"mtk1\">) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\"> = </span><span class=\"mtk11\">getQueryClient</span><span class=\"mtk1\">();</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk10\">Promise</span><span class=\"mtk1\">.</span><span class=\"mtk11\">all</span><span class=\"mtk1\">(</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk12\">queries</span><span class=\"mtk1\">.</span><span class=\"mtk11\">map</span><span class=\"mtk1\">(({ </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\"> }) </span><span class=\"mtk4\">=&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">.</span><span class=\"mtk11\">prefetchQuery</span><span class=\"mtk1\">({ </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\"> }),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    ),</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  );</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> </span><span class=\"mtk11\">dehydrate</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queryClient</span><span class=\"mtk1\">).</span><span class=\"mtk12\">queries</span><span class=\"mtk1\"> </span><span class=\"mtk15\">as</span><span class=\"mtk1\"> </span><span class=\"mtk10\">DehydratedQueryExtended</span><span class=\"mtk1\">&lt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk10\">UnwrapPromise</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">ReturnType</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Q</span><span class=\"mtk1\">[</span><span class=\"mtk10\">number</span><span class=\"mtk1\">][</span><span class=\"mtk8\">&#39;queryFn&#39;</span><span class=\"mtk1\">]&gt;&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  &gt;[];</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p>위의 유틸을 사용한 <code>Comments</code> 컴포넌트를 살펴보면 아래 첨부한 이미지처럼 두 개의 데이터가 들어오고 있습니다.</p>\n<pre class=\"grvsc-container default-dark\" data-language=\"tsx\" data-index=\"9\"><code class=\"grvsc-code\"><span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">Photo</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/model/photo&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> {</span><span class=\"mtk12\">Hydrate</span><span class=\"mtk1\">, </span><span class=\"mtk12\">getDehydratedQueries</span><span class=\"mtk1\">} </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/utils/react-query&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">import</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\"> </span><span class=\"mtk15\">from</span><span class=\"mtk1\"> </span><span class=\"mtk8\">&#39;@/service/photo/queries&#39;</span><span class=\"mtk1\">;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk15\">export</span><span class=\"mtk1\"> </span><span class=\"mtk15\">default</span><span class=\"mtk1\"> </span><span class=\"mtk4\">async</span><span class=\"mtk1\"> </span><span class=\"mtk4\">function</span><span class=\"mtk1\"> </span><span class=\"mtk11\">Comments</span><span class=\"mtk1\">({</span><span class=\"mtk12\">id</span><span class=\"mtk1\">}: </span><span class=\"mtk10\">Pick</span><span class=\"mtk1\">&lt;</span><span class=\"mtk10\">Photo</span><span class=\"mtk1\">, </span><span class=\"mtk8\">&#39;id&#39;</span><span class=\"mtk1\">&gt;) {</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> { </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\"> } = </span><span class=\"mtk12\">queryOptions</span><span class=\"mtk1\">.</span><span class=\"mtk11\">comments</span><span class=\"mtk1\">(</span><span class=\"mtk12\">id</span><span class=\"mtk1\">);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk4\">const</span><span class=\"mtk1\"> </span><span class=\"mtk12\">queries</span><span class=\"mtk1\"> = </span><span class=\"mtk15\">await</span><span class=\"mtk1\"> </span><span class=\"mtk11\">getDehydratedQueries</span><span class=\"mtk1\">([{ </span><span class=\"mtk12\">queryKey</span><span class=\"mtk1\">, </span><span class=\"mtk12\">queryFn</span><span class=\"mtk1\"> }]);</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  </span><span class=\"mtk15\">return</span><span class=\"mtk1\"> (</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;</span><span class=\"mtk10\">Hydrate</span><span class=\"mtk1\"> </span><span class=\"mtk12\">state</span><span class=\"mtk1\">=</span><span class=\"mtk4\">{</span><span class=\"mtk1\">{ </span><span class=\"mtk12\">queries</span><span class=\"mtk1\"> }</span><span class=\"mtk4\">}</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      comments</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">      </span><span class=\"mtk4\">{</span><span class=\"mtk10\">JSON</span><span class=\"mtk1\">.</span><span class=\"mtk11\">stringify</span><span class=\"mtk1\">(</span><span class=\"mtk12\">queries</span><span class=\"mtk1\">[</span><span class=\"mtk7\">0</span><span class=\"mtk1\">].</span><span class=\"mtk12\">state</span><span class=\"mtk1\">.</span><span class=\"mtk12\">data</span><span class=\"mtk1\">)</span><span class=\"mtk4\">}</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">    </span><span class=\"mtk17\">&lt;/</span><span class=\"mtk10\">Hydrate</span><span class=\"mtk17\">&gt;</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">  )</span></span></span>\n<span class=\"grvsc-line\"><span class=\"grvsc-source\"><span class=\"mtk1\">}</span></span></span></code></pre>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 720px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 138.33333333333334%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAAAsTAAALEwEAmpwYAAAESklEQVRIx42WS3vaVhRFPW+d2JLuQyCwECAQoIcFQjzD09hJ3I466KT//2esfleQxG0Sx4PzXSGJxbk6e29xVWs2mOU5H3c7trMZ+XBIFkWMh0PSXo95nlfnVpMJsywj9H2klGit0Uqd1xd1tWw22biae8tiYttMHYfScc6rlF9rrhSFUhwch76UOD8Dzs0NrRaTsiSOY1yvgVPzcNwajhBIpVBaVV+2tCIRgpEQ2D8DToWg7jgU0ykf1iv6+YRgXBIWc9pBG8/TSOkiHMWN0MRCMJSvAGdCULNtirLk+fmZz58/8/R4Yr8/kCRtDgfJeq3Y7wSztSKvKQavdVgKgWe2EcfM53OKouDx8bHafhC06HRc2m3NXVPhNjWpUgzfBEySCmhgx+OR3W5PUSSMRi5KSWxLYKnLln8FNM8wzTJ2ux37/Z7lcsnhcGC73VAUQ7IsJGi1vw7lTcAkTdlsNhwfHpiMx+w2W/bbPUHQZjQaMRoOK0gFlPLXwDhNq67W6zWz9YL5dkM2DSkmFkGgcGyB7eq3d2iGYjqcFgXdbEQ9DnHyEC9q47oaV+tvHb6qQ9um63n0ej36psKQUTTAbzbRrQa1oElNaWpKVe5IL8I2x646C15X4j//wFV+e0s/ipgdDiyPR+Ki4PauwXU54Hoxwo5DVDvgRil+c116Ulb1TusKajr9AjPr1U5K/vR9TkHAcxjyqdNhqRVz32PebjD36yyUZGmf/f2HZbG17crPRkKmvJcdHpXiY7PJ3vP4oDVzy2Jh6uaWxY3F0rJYOjZL4ZzLccgu2zZQAx+8mPpVaduIep3xek1WltidHtfhgPfdPjdujd+Fey5HV/Vea6zLdt+5bjWg6CVwKQTKtimNlz994uHpI+vDke3pifH9iLJQjAaa0VAyiBR19zwEMxADyf4PXDgOWohK2EaD89mM0/HAfZpxd6cpCsV0KilLyXis8LwaygD1GZh+BxTiDEwSVqtVZb+npyfKckaWpXS7NVzXxbI0jqMr2Je0fh146fB0OrHdbnl4OLFY5IzHLXzfRUoDOsPURXuvAk04GKeYyvO8CobD4bHy8XR6Txwn37p7S4dxklRJY+JrvVpVwbBa5AwiSRA08bzGt+5+BVSXtDFAkzRRkdGd5TTHbeL7WrVlISTaPbvC1Bdvpz+ack0aSUQUkwnTSUGa3+MHLcSgjQzbSHGWiWsLXEfgmtfo5c33nWxKy6IdhgzznH6ScNfpoBoNrH6AFQU4foNm4GL7DW7TLrejDlbQpOG3uP6RsI3Vjp0Of69W/LPb8VdZMmnWScc90vmA+0FA0fGqNdkkpEWfrOczdd3Kxwfb/i+w5/vE9TpdE2O2TSjEOVEcQc92quNQqsq3fduh7wj6Qlb3VeekrKLtazgor0Z3OCCfThkkCd0oYpimRHFMJ4qqz4HJyCyjNxoRJUl1Pc5zkjznrt1GXP6amPj6F35XELJ5fBz9AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Untitled\"\n        title=\"Untitled\"\n        src=\"/static/2d804deab0f591d646cbc8ed0d21f159/37523/5.png\"\n        srcset=\"/static/2d804deab0f591d646cbc8ed0d21f159/e9ff0/5.png 180w,\n/static/2d804deab0f591d646cbc8ed0d21f159/f21e7/5.png 360w,\n/static/2d804deab0f591d646cbc8ed0d21f159/37523/5.png 720w,\n/static/2d804deab0f591d646cbc8ed0d21f159/64d87/5.png 818w\"\n        sizes=\"(max-width: 720px) 100vw, 720px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<h2 id=\"덜-복잡한-코드를-작성할-순-없을까-reactquerystreamedhydration\" style=\"position:relative;\"><a href=\"#%EB%8D%9C-%EB%B3%B5%EC%9E%A1%ED%95%9C-%EC%BD%94%EB%93%9C%EB%A5%BC-%EC%9E%91%EC%84%B1%ED%95%A0-%EC%88%9C-%EC%97%86%EC%9D%84%EA%B9%8C-reactquerystreamedhydration\" aria-label=\"덜 복잡한 코드를 작성할 순 없을까 reactquerystreamedhydration permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>덜 복잡한 코드를 작성할 순 없을까? (ReactQueryStreamedHydration)</h2>\n<p>끝으로, 이렇게 dehydrate, hydrate 직접 시켜줘야 하는 코드가 심플하지 못하다고 생각하여 더 좋은 방법이 없는가 검색하던 중에 <a href=\"https://tanstack.com/query/v5/docs/react/guides/advanced-ssr#experimental-streaming-without-prefetching-in-nextjs\">ReactQueryStreamedHydration</a>을 발견했습니다. prefetching 없이도 streaming SSR을 작동 시키는 방법인데, 이 패키지를 사용하면 초기 요청 동안 서버에서 데이터를 가져오고 (useQuery 훅에서의 API 호출이 서버에서 이루어짐) 데이터가 준비되면 QueryClient에 전달하여 root에서 hydration을 수행하기 때문에 컴포넌트에서 useSuspenseQuery를 호출하기만 하면 됩니다. CSR에서 react-query를 사용하듯이 코드가 엄청나게 간단해집니다. 이는 놀라운 개발 경험(DX)과 낮은 코드 복잡성을 제공합니다.</p>\n<p>그러나 이 방법을 선택하지 않은 이유는, 실험 단계 인점이 가장 컸고 깊게 중첩된 쿼리가 없고 요청 최적화를 잘 관리하고 있는 경우 사용하기를 권장하고 있는데 따로 잘 관리할 자신이 없었던 점이 제일 컸습니다. 조금 더 자세히 알아보고 싶으신 분들은 공식 문서와 라이브러리 코드를 참고하시면 좋을 것 같습니다 :)</p>\n<h2 id=\"참고자료\" style=\"position:relative;\"><a href=\"#%EC%B0%B8%EA%B3%A0%EC%9E%90%EB%A3%8C\" aria-label=\"참고자료 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>참고자료</h2>\n<ul>\n<li>(공식문서) <a href=\"https://tanstack.com/query/latest/docs/react/guides/advanced-ssr\">Advanced Server Rendering</a></li>\n<li>(공식문서) <a href=\"https://tanstack.com/query/v5/docs/react/guides/advanced-ssr#experimental-streaming-without-prefetching-in-nextjs\">Experimental streaming without prefetching in Next.js</a></li>\n<li>예제 코드 구현: <a href=\"https://github.com/soobing/next-14-react-query\">https://github.com/soobing/next-14-react-query</a> by soobing</li>\n</ul>\n<style class=\"grvsc-styles\">\n  .grvsc-container {\n    overflow: auto;\n    position: relative;\n    -webkit-overflow-scrolling: touch;\n    padding-top: 1rem;\n    padding-top: var(--grvsc-padding-top, var(--grvsc-padding-v, 1rem));\n    padding-bottom: 1rem;\n    padding-bottom: var(--grvsc-padding-bottom, var(--grvsc-padding-v, 1rem));\n    border-radius: 8px;\n    border-radius: var(--grvsc-border-radius, 8px);\n    font-feature-settings: normal;\n    line-height: 1.4;\n  }\n  \n  .grvsc-code {\n    display: table;\n  }\n  \n  .grvsc-line {\n    display: table-row;\n    box-sizing: border-box;\n    width: 100%;\n    position: relative;\n  }\n  \n  .grvsc-line > * {\n    position: relative;\n  }\n  \n  .grvsc-gutter-pad {\n    display: table-cell;\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  .grvsc-gutter {\n    display: table-cell;\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter::before {\n    content: attr(data-content);\n  }\n  \n  .grvsc-source {\n    display: table-cell;\n    padding-left: 1.5rem;\n    padding-left: var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem));\n    padding-right: 1.5rem;\n    padding-right: var(--grvsc-padding-right, var(--grvsc-padding-h, 1.5rem));\n  }\n  \n  .grvsc-source:empty::after {\n    content: ' ';\n    -webkit-user-select: none;\n    -moz-user-select: none;\n    user-select: none;\n  }\n  \n  .grvsc-gutter + .grvsc-source {\n    padding-left: 0.75rem;\n    padding-left: calc(var(--grvsc-padding-left, var(--grvsc-padding-h, 1.5rem)) / 2);\n  }\n  \n  /* Line transformer styles */\n  \n  .grvsc-has-line-highlighting > .grvsc-code > .grvsc-line::before {\n    content: ' ';\n    position: absolute;\n    width: 100%;\n  }\n  \n  .grvsc-line-diff-add::before {\n    background-color: var(--grvsc-line-diff-add-background-color, rgba(0, 255, 60, 0.2));\n  }\n  \n  .grvsc-line-diff-del::before {\n    background-color: var(--grvsc-line-diff-del-background-color, rgba(255, 0, 20, 0.2));\n  }\n  \n  .grvsc-line-number {\n    padding: 0 2px;\n    text-align: right;\n    opacity: 0.7;\n  }\n  \n  .default-dark {\n    background-color: #1E1E1E;\n    color: #D4D4D4;\n  }\n  .default-dark .mtk3 { color: #6A9955; }\n  .default-dark .mtk8 { color: #CE9178; }\n  .default-dark .mtk15 { color: #C586C0; }\n  .default-dark .mtk1 { color: #D4D4D4; }\n  .default-dark .mtk12 { color: #9CDCFE; }\n  .default-dark .mtk4 { color: #569CD6; }\n  .default-dark .mtk11 { color: #DCDCAA; }\n  .default-dark .mtk10 { color: #4EC9B0; }\n  .default-dark .mtk7 { color: #B5CEA8; }\n  .default-dark .mtk17 { color: #808080; }\n  .default-dark .grvsc-line-highlighted::before {\n    background-color: var(--grvsc-line-highlighted-background-color, rgba(255, 255, 255, 0.1));\n    box-shadow: inset var(--grvsc-line-highlighted-border-width, 4px) 0 0 0 var(--grvsc-line-highlighted-border-color, rgba(255, 255, 255, 0.5));\n  }\n</style>","frontmatter":{"date":"January 07, 2024","title":"[React-Query] Next.js app router에서 사용하면서 고민했던 것들","categories":"react","author":"soobing"},"fields":{"slug":"/react/next-app-router-react-query/"}},"site":{"siteMetadata":{"siteUrl":"https://soobing.github.io","comments":{"utterances":{"repo":"soobing/soobing.github.io"}}}}},"pageContext":{"slug":"/react/server-rendering-and-react-query/","nextSlug":"/react/introducing-signals/","prevSlug":"/react/next-app-router-react-query/"}},
    "staticQueryHashes": ["1073350324","2938748437"]}